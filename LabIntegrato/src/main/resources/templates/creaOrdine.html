<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- <link rel="stylesheet" href="/clienteOrdine/css/styles.css"> --> 
    <title>Lista Prodotti</title>
</head>
<style>
* {
        box-sizing: border-box;
    }
    
    .blurred {
	    filter: blur(8px);
	    pointer-events: none; /* Disabilita i clic sugli elementi in background */
	}

    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f9;
        color: #333;
        margin: 0;
        padding: 0;
    }

    h1 {
        text-align: center;
        margin: 2rem 0 1rem;
        color: #2c3e50;
    }

    .product-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: center;
        padding: 2rem;
    }

    .card {
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        width: 300px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition: transform 0.2s;
    }

    .card:hover {
        transform: scale(1.02);
    }

    .image_container img {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }

    .content {
        padding: 1.5rem;
    }

    .title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #2c3e50;
    }

    .description {
        font-size: 0.875rem;
        color: #555;
        margin-bottom: 1rem;
    }

    .unit-price {
        font-size: 1rem;
        font-weight: 500;
        color: #555;
        margin-bottom: 0.75rem;
    }

    .quantity-container {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin-bottom: 1rem;
    }

    .quantity-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #2c3e50;
    }

    .quantity-select,
    .quantity-custom {
        padding: 0.5rem;
        font-size: 0.9rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        background-color: #f9f9f9;
        color: #333;
    }

    .quantity-custom {
        display: none;
        width: 60px;
    }

    .action {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-top: 1px solid #f0f0f0;
    }

    .price-total {
        font-size: 1rem;
        font-weight: 500;
        color: #555;
    }

    .cart-button {
        background-color: #3498db;
        color: #fff;
        font-size: 0.9rem;
        font-weight: 600;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .cart-button:hover {
        background-color: #2980b9;
    }

    .cart-button:focus {
        outline: none;
        box-shadow: 0 0 0 3px #85c1e9;
    }

    /* Stile per il pulsante del carrello */
    .cart-icon-button {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #3498db;
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: background-color 0.3s;
        z-index: 1001;
    }

    .cart-icon-button:hover {
        background-color: #2980b9;
    }

    /* Stile per il contatore del carrello */
    .cart-count {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #dc3545;
        color: #fff;
        font-size: 0.75rem;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* Stile per la sezione del carrello */
    .cart-section {
        position: fixed;
        top: 0;
        right: 0;
        width: 500px;
        max-width: 100%;
        height: 50px;
        background-color: rgba(52, 152, 219, 0);
        padding: 1rem;
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
        overflow-y: auto;
        z-index: 1000;
    }

    .cart-section.open {
        transform: translateX(0);
    }

    .master-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    /* Stile per il carrello e checkout */
    .cart-section .card.cart {
        margin-bottom: 1rem;
    }
    
    .card.cart {
	    flex: 1;
	    display: flex;
	    flex-direction: column;
	    height: 100%;
	}
	
	.card.checkout {
	    flex-shrink: 0;
	}

    /* Stile per gli elementi nel carrello */
    .cart .products {
        display: flex;
        flex-direction: column;
        padding: 10px;
    }
    
    .products {
	    max-height: 300px; /* Altezza massima della lista dei prodotti */
	    overflow-y: auto;  /* Scorrimento verticale */
	}
	
	.products::-webkit-scrollbar {
	    width: 0;
	    background: transparent;
	}
	
	.products:hover::-webkit-scrollbar {
	    width: 8px; /* Larghezza della scrollbar */
	}
	
	.products::-webkit-scrollbar-thumb {
	    background-color: #888;
	    border-radius: 4px;
	}
	
	.products::-webkit-scrollbar-thumb:hover {
	    background-color: #555;
	}

    .cart .products .product {
        display: grid;
        grid-template-columns: 60px 1fr 80px 1fr;
        gap: 10px;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
        position: relative;
    }

    .cart .products {
        display: flex;
        flex-direction: column;
        padding: 10px;
    }

    .cart .products .product {
        display: grid;
        grid-template-columns: 60px 1fr 80px 1fr;
        gap: 10px;
    }

    .cart .products .product span {
        font-size: 13px;
        font-weight: 600;
        color: #47484b;
        margin-bottom: 8px;
        display: block;
    }

    .cart .products .product p {
        font-size: 11px;
        font-weight: 600;
        color: #7a7c81;
    }

    .cart .product-info {
        flex: 2;
    }

    .cart .quantity {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .cart .price {
        flex: 1;
        text-align: right;
        font-weight: bold;
    }

    /* Stile per l'icona del cestino */
    .remove-item-button {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        margin-left: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .remove-item-button svg {
        width: 20px;
        height: 20px;
        fill: #e74c3c;
        transition: fill 0.3s;
    }

    .remove-item-button:hover svg {
        fill: #c0392b;
    }

    /* Stili per il checkout */
    .checkout .details {
        display: grid;
        grid-template-columns: 3fr 1fr;
        padding: 10px;
        gap: 5px;
    }

    .checkout .details span {
        font-size: 13px;
        font-weight: 600;
        color: #47484b;
        margin-bottom: 8px;
        display: block;
    }

    .checkout .details span:nth-child(odd) {
        color: #707175;
        text-align: left;
    }

    .checkout .details span:nth-child(even) {
        color: #47484b;
        text-align: right;
    }

    .checkout .checkout--footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 10px 10px 20px;
        background-color: #efeff3;
    }

    .checkout .price-total,
    .checkout .checkout--footer .price {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2c3e50;
    }

    .checkout .checkout-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 150px;
        height: 36px;
        background: linear-gradient(180deg, #4480FF 0%, #115DFC 50%, #0550ED 100%);
        box-shadow: 0px 0.5px 0.5px #EFEFEF, 0px 1px 0.5px rgba(239, 239, 239, 0.5);
        border-radius: 7px;
        border: 0;
        outline: none;
        color: #ffffff;
        font-size: 13px;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.15, 0.83, 0.66, 1);
        cursor: pointer;
    }

    .checkout .checkout-btn:hover {
        background: linear-gradient(180deg, #3563c3 0%, #0e43b8 50%, #044ebc 100%);
    }

    .cart-icon-button:hover + .cart-section,
    .cart-section:hover {
        transform: translateX(0);
    }

    /* Mantieni il carrello nascosto di default */
    .cart-section {
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out, background-color 0.3s ease-in-out;
        background-color: rgba(52, 152, 219, 0); /* Trasparente di default */
        display: flex;
    	flex-direction: column;
    	height: 100%;
    }

/* Stili per il Custom Alert */
.custom-alert {
    position: fixed; /* Posizione fissa rispetto alla viewport */
    top: 300px; /* 100px top del cart button + 50px altezza del cart button + 10px margine */
    right: 185px; /* Allineato a destra come il cart button */
    transform: scale(0); /* Inizialmente nascosto */
    width: 300px;
    background-color: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    z-index: 2000;
    opacity: 0;
    transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
    pointer-events: none; /* Evita interazioni quando nascosto */
}

.custom-alert.show {
    transform: scale(1); /* Mostra l'alert */
    opacity: 1;
    pointer-events: all; /* Permette interazioni quando visibile */
}

.custom-alert .card {
    width: 100%; /* Adatta alla larghezza del contenitore */
    height: auto; /* Altezza automatica */
    border-radius: 8px;
    box-sizing: border-box;
    padding: 10px 15px;
    background-color: #ffffff;
    box-shadow: rgba(149, 157, 165, 0.2) 0px 8px 24px;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: space-around;
    gap: 15px;
    /* Rimuovi pointer-events: none; per permettere interazioni */
}

.custom-alert .wave {
    position: absolute;
    transform: rotate(90deg);
    left: -31px;
    top: 32px;
    width: 80px;
    fill: #fc0c0c3a;
}

.custom-alert .icon-container {
    width: 35px;
    height: 35px;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #fc0c0c48;
    border-radius: 50%;
    margin-left: 8px;
}

.custom-alert .icon {
    width: 17px;
    height: 17px;
    color: #d10d0d;
}

.custom-alert .message-text-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: flex-start;
    flex-grow: 1;
}

.custom-alert .message-text,
.custom-alert .sub-text {
    margin: 0;
    cursor: default;
}

.custom-alert .message-text {
    color: #d10d0d;
    font-size: 17px;
    font-weight: 700;
}

.custom-alert .sub-text {
    font-size: 14px;
    color: #555;
}

.custom-alert .cross-icon {
    width: 18px;
    height: 18px;
    color: #555;
    cursor: pointer;
}

.custom-alert .cross-icon:hover {
    color: #e74c3c;
}

/* Responsive Design */
@media (max-width: 600px) {
    .custom-alert {
        width: 90%;
        right: 5%; /* Centra l'alert su schermi piccoli */
    }

    .custom-alert .card {
        flex-direction: column;
        align-items: center;
    }
}

.rotate-y {
  animation: rotateY 1s infinite linear;
}

@keyframes rotateY {
  to {
    transform: rotateY(360deg);
  }
}
</style>
<body>

    <button class="cart-icon-button" onclick="toggleCart()">
        üõí
        <div class="cart-count" id="cartCount">0</div>
    </button>

    <div class="cart-section" id="cartSection">
        <div class="master-container">
            <div class="card cart">
                <label class="title">Il tuo carrello</label>
                <div class="products">
                    <!-- Prodotti aggiunti al carrello verranno inseriti qui -->
                </div>
            </div>
          
            <div class="card checkout">
                <label class="title">Checkout</label>
                <div class="details">
                    <span>Subtotale carrello:</span>
                    <span id="cartSubtotal">‚Ç¨0.00</span>
                    <span>Sconto tramite coupon applicati:</span>
                    <span id="cartDiscount">‚Ç¨0.00</span>
                    <span>Spese di spedizione:</span>
                    <span id="cartShipping">‚Ç¨0.00</span>
                </div>
                <div class="checkout--footer">
                    <label class="price" id="cartTotal"><sup>‚Ç¨</sup>0.00</label>
                    <button class="checkout-btn" onclick="checkout()">Conferma ordine</button>
                </div>
            </div>
        </div>
    </div> 

    <h1>Prodotti in Vendita</h1>

    <div id="product-list" class="product-container"></div>
    
    <!-- <script src="static/clienteOrdine/js/script.js"></script> --> 
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3/build/jwt-decode.min.js"></script>
    
    <script>
 	// Definizione globale dei prodotti
    let prodotti = [];

    async function fetchProdotti() {
        try {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                throw new Error('Token non trovato. Autenticazione richiesta.');
            }

            const response = await fetch('/cliente/pezzi', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                throw new Error(`Errore HTTP! Stato: ${response.status}`);
            }

            prodotti = await response.json();
            renderProductList(); // Chiama la funzione per renderizzare i prodotti dopo averli ottenuti
        } catch (error) {
            console.error('Errore nel fetch dei prodotti:', error);
            Swal.fire({
                icon: 'error',
                title: 'Errore',
                text: 'Impossibile caricare i prodotti. Riprova pi√π tardi.',
                confirmButtonText: 'OK'
            });
        }
    }

    let cartItemCount = 0;
    let cartItems = [];

    // Funzione per alternare la visualizzazione del carrello
    function toggleCart() {
        const cartSection = document.getElementById('cartSection');
        cartSection.classList.toggle('open');
    }

    // Funzione per aggiornare il conteggio degli articoli nel carrello
	function updateCartCount() {
	    const totalItems = cartItems.reduce((acc, item) => acc + item.quantity + item.toProduce, 0);
	    document.getElementById('cartCount').textContent = totalItems;
	}

    // Funzione per aggiungere un prodotto al carrello
	function addToCart(productId) {
	    const prodotto = prodotti.find(p => p.id === productId);
	    if (!prodotto) {
	        console.error(`Prodotto con ID ${productId} non trovato`);
	        return;
	    }
	
	    // Seleziona la card del prodotto
	    const productCard = document.querySelector(`.card[data-product-id="${productId}"]`);
	    if (!productCard) {
	        console.error(`Card per il prodotto ID ${productId} non trovata`);
	        return;
	    }
	
	    // Ottieni la quantit√† selezionata
	    const selectElement = productCard.querySelector('.quantity-select');
	    const customInput = productCard.querySelector('.quantity-custom');
	    let desiredQuantity;
	    if (selectElement.value === 'custom') {
	        desiredQuantity = parseInt(customInput.value) || 1;
	    } else {
	        desiredQuantity = parseInt(selectElement.value) || 1;
	    }
	
	    // Calcola quanto √® disponibile
	    const available = prodotto.disponibilita;
	
	    let quantityToAdd = desiredQuantity;
	    let toProduce = 0;
	
	    if (desiredQuantity > available) {
	        quantityToAdd = available;
	        toProduce = desiredQuantity - available;
	    }
	
	    // Trova se il prodotto √® gi√† nel carrello
	    const existingItem = cartItems.find(item => item.id === productId);
	    if (existingItem) {
	        existingItem.quantity += quantityToAdd;
	        existingItem.toProduce += toProduce;
	        existingItem.total = existingItem.quantity * existingItem.prezzo + existingItem.toProduce * existingItem.prezzo;
	    } else {
	        cartItems.push({
	            id: prodotto.id,
	            nome: prodotto.nome,
	            prezzo: prodotto.prezzo,
	            quantity: quantityToAdd,
	            toProduce: toProduce,
	            total: (quantityToAdd + toProduce) * prodotto.prezzo
	        });
	    }
	
	    // Aggiorna la disponibilit√† del prodotto
	    prodotto.disponibilita -= quantityToAdd;
	
	    // Aggiorna il conteggio totale del carrello (includendo i prodotti da produrre)
	    cartItemCount += desiredQuantity;
	
	    updateCartCount();
	    renderCartItems();
	    updateCheckoutTotals();
	}

    // Funzione per rendere dinamicamente gli articoli nel carrello
	function renderCartItems() {
	    const cartItemsContainer = document.querySelector('#cartSection .products');
	    cartItemsContainer.innerHTML = ''; // Pulisce il contenuto precedente
	
	    cartItems.forEach(item => {
	        const itemElement = document.createElement('div');
	        itemElement.classList.add('product');
	
	        itemElement.innerHTML = `
	            <div class="product-info">
	                <span>${item.nome}</span>
	                <p>Prezzo unitario: ‚Ç¨${item.prezzo.toFixed(2)}</p>
	                <p>Quantit√†: ${item.quantity} (Disponibili) + ${item.toProduce} (Da produrre)</p>
	            </div>
	            <div class="quantity">
	                <button onclick="decreaseQuantity(${item.id})">-</button>
	                <span>${item.quantity + item.toProduce}</span>
	                <button onclick="increaseQuantity(${item.id})">+</button>
	            </div>
	            <div class="price">
	                ‚Ç¨${item.total.toFixed(2)}
	            </div>
	            <button class="remove-item-button" onclick="removeItem(${item.id})" title="Rimuovi dal carrello">
	                <!-- Icona SVG del cestino -->
	                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
	                    <path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64v32c0 17.7 14.3 32 32 32h16l25.6 368c.6 8.7 7.4 16 16 16h224c8.6 0 15.4-7.3 16-16L368 128h16c17.7 0 32-14.3 32-32V64c0-17.7-14.3-32-32-32h-96l-7.2-14.3C257.1 7.5 248.3 0 238.4 0H209.6c-9.9 0-18.7 7.5-23.2 17.7zM48 96h352v32H48V96z"/>
	                </svg>
	            </button>
	        `;
	
	        cartItemsContainer.appendChild(itemElement);
	    });
	}

    // Funzione per aumentare la quantit√† di un prodotto nel carrello
    function increaseQuantity(productId) {
        const prodotto = prodotti.find(p => p.id === productId);
        const item = cartItems.find(item => item.id === productId);
        if (prodotto && item) {
            if (prodotto.disponibilita > 0) {
                item.quantity += 1;
                item.total = item.quantity * item.prezzo;
                prodotto.disponibilita -= 1;
                cartItemCount += 1;
            } else {
                item.toProduce += 1;
            }
            updateCartCount();
            renderCartItems();
            updateCheckoutTotals();
        }
    }

    // Funzione per diminuire la quantit√† di un prodotto nel carrello
    function decreaseQuantity(productId) {
        const prodotto = prodotti.find(p => p.id === productId);
        const item = cartItems.find(item => item.id === productId);
        if (prodotto && item) {
            if (item.quantity > 0) {
                item.quantity -= 1;
                item.total = item.quantity * item.prezzo;
                prodotto.disponibilita += 1;
                cartItemCount -= 1;

                if (item.toProduce > 0) {
                    item.toProduce -= 1;
                }

                if (item.quantity === 0 && item.toProduce === 0) {
                    // Rimuovi l'item se non ci sono pi√π pezzi
                    cartItems = cartItems.filter(item => item.id !== productId);
                }
            }
            updateCartCount();
            renderCartItems();
            updateCheckoutTotals();
        }
    }

    // Funzione per rimuovere un prodotto dal carrello
    function removeItem(productId) {
        const prodotto = prodotti.find(p => p.id === productId);
        const itemIndex = cartItems.findIndex(item => item.id === productId);
        if (prodotto && itemIndex !== -1) {
            const item = cartItems[itemIndex];
            // Ripristina la disponibilit√†
            prodotto.disponibilita += item.quantity;
            // Rimuovi l'item dal carrello
            cartItems.splice(itemIndex, 1);
            cartItemCount -= item.quantity;
            updateCartCount();
            renderCartItems();
            updateCheckoutTotals();
        }
    }

    // Funzione per aggiornare i totali nel checkout
    function updateCheckoutTotals() {
        const subtotal = cartItems.reduce((acc, item) => acc + item.total, 0);
        const discount = 0; // Implementa la logica dei coupon se necessario
        const shipping = cartItems.length > 0 ? 4.99 : 0; // Spese di spedizione solo se ci sono articoli

        // Calcola i costi aggiuntivi per i pezzi da produrre basati sul prezzo del prodotto
        const productionTotal = cartItems.reduce((acc, item) => {
            return acc + (item.toProduce > 0 ? item.toProduce * item.prezzo : 0);
        }, 0);

        const total = subtotal - discount + shipping + productionTotal;

        // Aggiorna i valori nel checkout
        const detailsSpans = document.querySelectorAll('.checkout .details span');
        if (detailsSpans.length >= 6) {
            detailsSpans[1].textContent = `‚Ç¨${subtotal.toFixed(2)}`;
            detailsSpans[3].textContent = `‚Ç¨${discount.toFixed(2)}`;
            detailsSpans[5].textContent = `‚Ç¨${shipping.toFixed(2)}`;
        }

        // Aggiungi o aggiorna una sezione per i costi di produzione extra
        let productionSpan = document.getElementById('cartProduction');
        if (productionTotal > 0) {
            if (!productionSpan) {
                const detailsDiv = document.querySelector('.checkout .details');
                productionSpan = document.createElement('span');
                productionSpan.id = 'cartProduction';
                productionSpan.textContent = `Costi produzione extra: ‚Ç¨${productionTotal.toFixed(2)}`;
                detailsDiv.appendChild(productionSpan);
            } else {
                productionSpan.textContent = `Costi produzione extra: ‚Ç¨${productionTotal.toFixed(2)}`;
            }
        } else {
            if (productionSpan) {
                productionSpan.remove();
            }
        }

        document.getElementById('cartTotal').textContent = `‚Ç¨${total.toFixed(2)}`;
    }

    // Funzione checkout
    function checkout() {
        console.log('Checkout cliccato'); // Debug
        if (cartItems.length === 0) {
            // Mostra un alert di avviso se il carrello √® vuoto
            Swal.fire({
                icon: 'warning',
                title: 'Il tuo carrello √® vuoto!',
                text: 'Aggiungi dei prodotti al carrello per continuare.',
                confirmButtonText: 'OK'
            });
            return;
        }

        // Controlla se ci sono prodotti da produrre
        const itemsToProduce = cartItems.filter(item => item.toProduce > 0);

        if (itemsToProduce.length > 0) {
            // Costruisci un messaggio dettagliato
            let produceMessage = 'Hai aggiunto pi√π prodotti di quelli disponibili. I seguenti articoli richiedono produzione extra:<br><ul>';
            itemsToProduce.forEach(item => {
                produceMessage += `<li>${item.nome}: ${item.toProduce} pezzo/i da produrre</li>`;
            });
            produceMessage += '</ul>Vuoi procedere comunque?';

            Swal.fire({
                icon: 'info',
                title: 'Produzione Extra Necessaria',
                html: produceMessage,
                showCancelButton: true,
                confirmButtonText: 'Procedi',
                cancelButtonText: 'Annulla',
            }).then((result) => {
                if (result.isConfirmed) {
                    proceedToConfirmOrder();
                } else {
                    Swal.fire('Ordine non confermato', 'Puoi continuare a modificare il tuo carrello.', 'info');
                }
            });
        } else {
            // Nessun prodotto extra, procedi normalmente
            proceedToConfirmOrder();
        }
    }

    // Funzione per procedere alla conferma dell'ordine
	async function proceedToConfirmOrder() {
	    const doubleCheckIcon = `
	        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="32">
	            <path d="M342.6 86.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L160 178.7l-57.4-57.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l80 80c12.5 12.5 32.8 12.5 45.3 0l160-160zm96 128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L160 402.7 54.6 297.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l256-256z" fill="currentColor" />
	        </svg>
	    `;
	
	    const result = await Swal.fire({
	        icon: 'warning',
	        title: 'Sicuro di voler confermare l\'ordine?',
	        showDenyButton: true,
	        showCancelButton: true,
	        confirmButtonText: 'S√¨',
	        denyButtonText: 'No',
	        customClass: {
	            actions: 'my-actions',
	            denyButtonText: 'order-1 right-gap',
	            confirmButton: 'order-2'
	        },
	    });
	
	    if (result.isConfirmed) {
	        try {
	            const ordineResponse = await creaOrdine();
	            
	            // Se l'ordine √® stato creato con successo, mostra un messaggio di successo
	            Swal.fire({
	                title: 'Ordine confermato!', 
	                icon: 'success',
	                iconHtml: doubleCheckIcon,
	                customClass: {
	                    icon: 'rotate-y',
	                },
	                showConfirmButton: false,
	                timer: 2500 // L'alert scomparir√† automaticamente dopo 2 secondi
	            }).then(() => {
	                // Reindirizza alla pagina personale dopo la conferma
	                window.location.assign("paginaPersonale");
	            });
	        } catch (error) {
	            // Se c'√® stato un errore, mostralo con un alert
	            Swal.fire({
	                title: 'Errore',
	                icon: 'error',
	                text: error.message || 'Si √® verificato un errore durante la creazione dell\'ordine',
	                confirmButtonText: 'OK'
	            });
	        }
	    } else if (result.isDenied) {
	        Swal.fire('Ordine non confermato', 'Puoi continuare a modificare il tuo carrello.', 'info');
	    }
	}

    // Funzione per creare le card dei prodotti
    function createProductCard(prodotto) {
        const card = document.createElement('div');
        card.classList.add('card');
        card.setAttribute('data-product-id', prodotto.id);

        card.innerHTML = `
            <div class="image_container">
                <img src="${prodotto.immagineUrl}" alt="${prodotto.nome}">
            </div>
            <div class="content">
                <h2 class="title">${prodotto.nome}</h2>
                <p class="description">${prodotto.descrizione}</p>
                <div class="unit-price">Prezzo unitario: ‚Ç¨${prodotto.prezzo.toFixed(2)}</div>
                <div class="disponibilita">Disponibilit√† pezzi: ${prodotto.disponibilita}</div>

                <div class="quantity-container">
                    <span class="quantity-label">Quantit√†:</span>
                    <select class="quantity-select" onchange="toggleCustomQuantity(this); updatePrice(${prodotto.id}, ${prodotto.prezzo});">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="custom">Altro</option>
                    </select>
                    <input type="number" min="1" class="quantity-custom" placeholder="Inserisci" oninput="updatePrice(${prodotto.id}, ${prodotto.prezzo})" style="display: none;">
                </div>
            </div>

            <div class="action">
                <div class="price-total" id="price-${prodotto.id}">Totale: ‚Ç¨${prodotto.prezzo.toFixed(2)}</div>
                <button class="cart-button" onclick="addToCart(${prodotto.id})">
                    Aggiungi al carrello
                </button>
            </div>
        `;

        return card;
    }

    // Funzione per alternare la visibilit√† dell'input personalizzato per la quantit√†
    function toggleCustomQuantity(selectElement) {
        const customInput = selectElement.parentElement.querySelector('.quantity-custom');
        if (selectElement.value === 'custom') {
            customInput.style.display = 'block';
            customInput.focus();
        } else {
            customInput.style.display = 'none';
        }
    }

    // Funzione per aggiornare il prezzo totale nella card del prodotto
    function updatePrice(productId, unitPrice) {
        const card = document.querySelector(`.card[data-product-id="${productId}"]`);
        const selectElement = card.querySelector('.quantity-select');
        const customInput = card.querySelector('.quantity-custom');
        let quantity = selectElement.value === 'custom' && customInput.value ? parseInt(customInput.value) : parseInt(selectElement.value);
        quantity = quantity || 1;

        const totalPrice = quantity * unitPrice;
        const priceElement = card.querySelector(`#price-${productId}`);
        priceElement.textContent = `Totale: ‚Ç¨${totalPrice.toFixed(2)}`;
    }

    // Inizializzazione al caricamento della pagina
    document.addEventListener('DOMContentLoaded', () => {
        verifyToken();
    });

    async function verifyToken() {
        try {
            const token = localStorage.getItem('jwtToken');
            console.log(token);
            if (!token) {
                throw new Error('Token non trovato. Autenticazione richiesta.');
            }

            // Decodifica il token usando jwt-decode
            const payload = jwt_decode(token);
            if (!payload) {
                throw new Error('Token non valido.');
            }

            // Controlla il ruolo nel payload
            if (Array.isArray(payload.roles) && payload.roles.includes('ROLE_CLIENTE')) {
	            // Il ruolo √® autorizzato, procedi con il fetch dei prodotti
	            await fetchProdotti();
	        } else {
	            throw new Error('Ruolo non autorizzato.');
	        }

        } catch (error) {
            console.error('Errore nella verifica del token:', error);
            Swal.fire({
                icon: 'error',
                title: 'Autenticazione Fallita',
                text: 'Il tuo token non √® valido o √® scaduto. Effettua nuovamente l\'accesso.',
                confirmButtonText: 'OK'
            }).then(() => {
                // Reindirizza l'utente alla pagina di login o esegui altre azioni necessarie
                window.location.href = '/public/login';
            });
        }
    }

    function renderProductList() {
        const productContainer = document.getElementById('product-list');
        productContainer.innerHTML = ''; // Pulisce il contenuto precedente

        prodotti.forEach(prodotto => {
            const productCard = createProductCard(prodotto);
            productContainer.appendChild(productCard);
        });
    }
    
    async function creaOrdine() {
        const token = localStorage.getItem('jwtToken');
        const prodottiCarrello = cartItems.map(item => ({
            codicePezzo: item.id, 
            quantita: item.quantity + item.toProduce
        }));
        
        console.log(prodottiCarrello);

        try {
            const response = await fetch('/cliente/crea/ordine', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(prodottiCarrello)
            });

         // Controlla se la risposta √® OK
            if (!response.ok) {
                const errorData = await response.json(); // Legge il corpo della risposta
                throw new Error(errorData.message || 'Errore durante la creazione dell\'ordine');
            }

            const result = await response.json();
            return result; // Ritorna il risultato per poterlo usare in altre funzioni
        } catch (error) {
            console.error('Errore durante la creazione dell\'ordine:', error);
            return Promise.reject(error); // Rifiuta la Promise in caso di errore
        }
    }

</script>

</body>
</html>
